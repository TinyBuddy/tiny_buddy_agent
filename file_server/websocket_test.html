<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket代理测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-custom {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .bg-gradient-blue {
                background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-800 mb-2">WebSocket代理测试工具</h1>
            <p class="text-gray-600 text-lg">测试Nginx代理服务器是否正确支持WebSocket连接</p>
        </header>

        <main class="bg-white rounded-xl shadow-custom p-6 md:p-8">
            <!-- 连接配置 -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-cogs text-primary mr-2"></i>连接配置
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="websocketUrl" class="block text-sm font-medium text-gray-700 mb-1">WebSocket URL</label>
                        <input
                            type="text"
                            id="websocketUrl"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                            value="ws://localhost:8080/proxy"
                            placeholder="ws://localhost:8080/proxy"
                        >
                    </div>
                    <div class="flex items-end">
                        <button
                            id="connectBtn"
                            class="w-full bg-gradient-blue text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all flex items-center justify-center"
                        >
                            <i class="fa fa-plug mr-2"></i>连接
                        </button>
                    </div>
                </div>
            </div>

            <!-- 连接状态 -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-signal text-primary mr-2"></i>连接状态
                </h2>
                <div class="flex items-center space-x-2">
                    <span id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-400 transition-colors"></span>
                    <span id="statusText" class="text-gray-600">未连接</span>
                </div>
            </div>

            <!-- 消息记录 -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-comments text-primary mr-2"></i>消息记录
                </h2>
                <div id="messageLog" class="w-full h-60 border border-gray-200 rounded-lg p-3 bg-gray-50 overflow-y-auto font-mono text-sm mb-3"></div>
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="messageInput"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all"
                        placeholder="输入消息..."
                        disabled
                    >
                    <button
                        id="sendBtn"
                        class="bg-primary text-white font-medium py-2 px-4 rounded-lg shadow hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        发送
                    </button>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-check-circle text-primary mr-2"></i>测试结果
                </h2>
                <div id="testResult" class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <p class="text-gray-600"><i class="fa fa-info-circle text-info mr-2"></i>请先连接WebSocket服务器进行测试</p>
                </div>
            </div>

            <!-- 提示说明 -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 class="font-medium text-blue-800 mb-2 flex items-center">
                    <i class="fa fa-lightbulb-o text-warning mr-2"></i>测试说明
                </h3>
                <ul class="list-disc list-inside text-blue-700 space-y-1 text-sm">
                    <li>确保Nginx服务器已启动并配置正确</li>
                    <li>确保WebSocket测试服务器（websocket_test_server.js）已启动</li>
                    <li>默认WebSocket URL为 ws://localhost:8080/proxy，指向Nginx代理的WebSocket服务</li>
                    <li>连接成功后，可以发送消息测试双向通信</li>
                </ul>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p>WebSocket代理测试工具 &copy; 2023</p>
        </footer>
    </div>

    <script>
        // 获取DOM元素
        const websocketUrl = document.getElementById('websocketUrl');
        const connectBtn = document.getElementById('connectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const messageLog = document.getElementById('messageLog');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const testResult = document.getElementById('testResult');

        let ws = null;
        let isConnected = false;
        
        // 记录消息函数
        function logMessage(message, type = 'system') {
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            
            let typeClass = 'text-gray-600'; // 系统消息
            let typeLabel = '系统';
            
            if (type === 'sent') {
                typeClass = 'text-blue-600';
                typeLabel = '发送';
            } else if (type === 'received') {
                typeClass = 'text-green-600';
                typeLabel = '接收';
            } else if (type === 'error') {
                typeClass = 'text-red-600';
                typeLabel = '错误';
            }
            
            messageElement.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="font-medium ${typeClass}">[${typeLabel}]</span> ${message}`;
            messageLog.appendChild(messageElement);
            messageLog.scrollTop = messageLog.scrollHeight;
        }
        
        // 更新状态函数
        function updateStatus(connected) {
            isConnected = connected;
            
            if (connected) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-success transition-colors';
                statusText.className = 'text-success';
                statusText.textContent = '已连接';
                connectBtn.innerHTML = '<i class="fa fa-unplug mr-2"></i>断开连接';
                messageInput.disabled = false;
                sendBtn.disabled = false;
                
                // 更新测试结果
                testResult.className = 'p-4 rounded-lg bg-green-50 border border-green-100';
                testResult.innerHTML = '<p class="text-green-700"><i class="fa fa-check-circle text-success mr-2"></i>WebSocket代理测试通过！</p>';
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-gray-400 transition-colors';
                statusText.className = 'text-gray-600';
                statusText.textContent = '未连接';
                connectBtn.innerHTML = '<i class="fa fa-plug mr-2"></i>连接';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // 更新测试结果
                testResult.className = 'p-4 rounded-lg bg-gray-50 border border-gray-200';
                testResult.innerHTML = '<p class="text-gray-600"><i class="fa fa-info-circle text-info mr-2"></i>请先连接WebSocket服务器进行测试</p>';
            }
        }
        
        // 连接WebSocket
        function connectWebSocket() {
            if (isConnected) {
                // 断开连接
                if (ws) {
                    ws.close();
                    ws = null;
                }
                updateStatus(false);
                logMessage('已断开WebSocket连接', 'system');
                return;
            }
            
            const url = websocketUrl.value.trim();
            
            if (!url) {
                logMessage('请输入有效的WebSocket URL', 'error');
                return;
            }
            
            try {
                ws = new WebSocket(url);
                
                // 连接建立
                ws.onopen = () => {
                    logMessage(`已连接到 ${url}`, 'system');
                    updateStatus(true);
                };
                
                // 接收消息
                ws.onmessage = (event) => {
                    logMessage(event.data, 'received');
                };
                
                // 连接关闭
                ws.onclose = () => {
                    logMessage('WebSocket连接已关闭', 'system');
                    updateStatus(false);
                    ws = null;
                };
                
                // 连接错误
                ws.onerror = (error) => {
                    logMessage(`WebSocket连接错误: ${error}`, 'error');
                    updateStatus(false);
                    ws = null;
                };
            } catch (error) {
                logMessage(`连接失败: ${error}`, 'error');
                updateStatus(false);
            }
        }
        
        // 发送消息
        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message) {
                logMessage('请输入消息内容', 'error');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                logMessage(message, 'sent');
                messageInput.value = '';
                messageInput.focus();
            } else {
                logMessage('WebSocket未连接，无法发送消息', 'error');
            }
        }
        
        // 事件监听
        connectBtn.addEventListener('click', connectWebSocket);
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 页面加载完成
        window.addEventListener('load', () => {
            logMessage('欢迎使用WebSocket代理测试工具', 'system');
            logMessage('请配置WebSocket URL并点击连接按钮开始测试', 'system');
        });
    </script>
</body>
</html>